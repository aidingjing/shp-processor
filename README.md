# SHP文件处理工具

一个用于从MySQL数据库查询并导出空间数据到SHP文件的图形化工具。

## 主要功能

- 📊 **MySQL数据库连接** - 支持自定义数据库配置
- 🔍 **SQL查询执行** - 灵活的数据查询功能
- 🧭 **智能坐标解析** - 自动识别坐标字段格式
- 🗺️ **多几何类型支持** - 点、线、面自动识别
- 📁 **SHP文件导出** - 支持多种坐标系
- 🔄 **SHP文件合并** - 支持多个SHP文件智能合并
- 📈 **空间统计分析** - 面图层与目标图层的空间关系统计
- 🖥️ **图形化界面** - 友好的用户操作体验

## 安装要求

### Python版本
- Python 3.8 或更高版本

### 依赖包安装
```bash
pip install -r requirements.txt
```

### Windows用户注意事项
如果geopandas安装失败，建议使用conda：
```bash
conda install -c conda-forge geopandas
```

## 快速开始

### 1. 启动程序
```bash
python main.py
```

### 2. 数据库配置
- 在"数据库配置"面板中填写MySQL连接信息
- 点击"测试连接"验证配置
- 保存配置以备后用

### 3. 执行SQL查询
- 在"SQL查询"面板中编写查询语句
- 确保查询结果包含空间坐标字段
- 坐标字段格式应为：`[[经度,纬度],...]`

### 4. 选择坐标字段
- 在"字段选择"面板中选择包含空间坐标的字段
- 系统会自动分析数据格式和几何类型
- 确认选择结果

### 5. 导出SHP文件
- 在"导出配置"面板中设置输出路径
- 选择合适的坐标系（默认WGS84）
- 点击"执行导出"完成操作

### 6. 使用SHP文件合并工具
- 在菜单栏选择"工具" > "SHP文件合并工具"
- 添加两个或多个SHP文件到列表中
- 选择目标坐标系（推荐"auto"自动选择）
- 选择合并策略（"联合"或"追加"）
- 点击"预览合并信息"查看兼容性
- 选择输出路径并点击"开始合并"

### 7. 使用空间统计分析工具
- 在菜单栏选择"工具" > "空间统计分析"
- 选择面图层作为统计区域（必须包含Polygon或MultiPolygon几何类型）
- 选择目标图层（点、线或面类型）
- 配置分析参数（坐标系、容差等）
- 生成预览查看数据兼容性
- 执行分析查看统计结果
- 导出结果为SHP或Excel格式

## 坐标字段格式

工具支持以下坐标格式：

### 点数据
```json
[[116.404, 39.915]]
```

### 线数据
```json
[[116.404, 39.915], [116.405, 39.916], [116.406, 39.917]]
```

### 面数据（闭合）
```json
[[116.404, 39.915], [116.405, 39.916],
 [116.406, 39.917], [116.404, 39.915]]
```

## 支持的坐标系

- WGS84 (EPSG:4326) - 默认
- GCJ02 (EPSG:4490) - 中国测绘坐标系
- Web Mercator (EPSG:3857)
- UTM Zone 49N (EPSG:32649)
- UTM Zone 50N (EPSG:32650)

## 示例SQL查询

```sql
-- 查询包含坐标的点数据
SELECT id, name, coordinates
FROM poi_points
WHERE city = '北京'
LIMIT 1000;

-- 查询线数据
SELECT road_id, road_name, coordinates
FROM road_network
WHERE length > 100;

-- 查询面数据
SELECT area_id, area_name, coordinates, area_type
FROM administrative_areas
WHERE level = 'district';
```

## 配置文件

程序支持配置文件保存和加载：

### mysql_config.json
```json
{
    "host": "localhost",
    "port": 3306,
    "user": "your_username",
    "password": "your_password",
    "database": "your_database",
    "charset": "utf8mb4"
}
```

## SHP文件合并工具

### 功能特点
- **智能兼容性检查** - 自动检查文件间的几何类型和坐标系兼容性
- **多种坐标系支持** - 支持WGS84、GCJ02、Web Mercator等常用坐标系
- **灵活合并策略** - 支持联合合并（去重）和追加合并（保留重复）
- **详细预览信息** - 合并前可查看文件兼容性和要素统计
- **几何类型标准化** - 自动处理不同几何类型间的转换

### 合并策略说明
- **联合合并**：合并所有要素并自动去除重复的几何对象，适合需要数据去重的场景
- **追加合并**：简单连接所有要素，保留所有数据，适合需要保留原始数据的场景

### 兼容性要求
- **几何类型兼容性**：相同类型的几何对象（点/线/面）可以完美合并
- **坐标系兼容性**：相同或可转换坐标系的文件可以合并，不同坐标系会自动转换
- **字段兼容性**：不同字段结构的文件也可以合并，缺失字段会用空值填充

### 使用示例
1. 打开"工具" > "SHP文件合并工具"
2. 添加多个相同几何类型的SHP文件
3. 选择"auto"自动坐标系或指定目标坐标系
4. 选择"联合"合并策略去除重复要素
5. 预览合并信息确认兼容性
6. 选择输出路径并执行合并

## 空间统计分析工具

### 功能特点
- **面图层统计** - 以面图层为统计区域，分析目标要素的空间分布
- **多几何类型支持** - 支持点、线、面三种几何类型的统计分析
- **避免重复统计** - 采用最大归属原则，每个目标要素只统计一次
- **详细统计结果** - 提供完整的统计信息和多种导出格式
- **智能算法优化** - 使用空间索引和批量处理提高分析效率

### 统计原理
- **点要素统计**：统计完全落入或接触面边界的点数量
- **线要素统计**：计算线段与面的交集比例，归属比例最高的面
- **面要素统计**：计算面与面的重叠面积，归属面积最大的面

### 算法特点
- **最大归属原则**：每个目标要素只归属于一个统计面
- **空间索引优化**：使用R-tree索引加速空间查询
- **容差处理**：支持设置分析容差处理边界情况
- **坐标系自动转换**：支持不同坐标系间的自动转换

### 使用示例
1. 打开"工具" > "空间统计分析"
2. 选择包含行政区域的面图层
3. 选择要统计的目标图层（如POI点、道路线等）
4. 配置分析参数（坐标系、容差等）
5. 生成预览检查数据兼容性
6. 执行分析获取统计结果
7. 导出结果为SHP文件或Excel表格

## 项目结构

```
shp-processor/
├── config/                  # 配置模块
│   ├── __init__.py
│   └── mysql_config.py
├── core/                    # 核心功能
│   ├── __init__.py
│   ├── mysql_connector.py
│   ├── coordinate_parser.py
│   ├── shapefile_exporter.py
│   ├── shapefile_merger.py  # SHP文件合并模块
│   └── spatial_analyzer.py  # 空间统计分析模块
├── gui/                     # 图形界面
│   ├── __init__.py
│   ├── main_window.py
│   ├── database_config_frame.py
│   ├── query_frame.py
│   ├── field_selection_frame.py
│   ├── export_frame.py
│   ├── shapefile_merger_dialog.py  # SHP合并对话框
│   └── spatial_analysis_dialog.py  # 空间分析对话框
├── utils/                   # 工具函数
│   ├── __init__.py
│   └── geometry_utils.py
├── main.py                  # 主程序入口
├── requirements.txt         # 依赖包列表
├── config_example.json      # 配置文件示例
└── README.md               # 说明文档
```

## 常见问题

### 1. 连接数据库失败
- 检查数据库服务是否启动
- 验证连接参数是否正确
- 确认网络连接是否正常

### 2. 坐标解析失败
- 确保坐标字段格式正确
- 检查是否包含非法字符
- 验证经纬度范围是否合理

### 3. 导出SHP文件失败
- 检查输出路径是否有写入权限
- 确保磁盘空间充足
- 验证坐标数据是否有效

### 4. 几何类型识别错误
- 可以手动指定几何类型
- 检查坐标数据格式
- 查看字段分析结果

### 5. SHP文件合并失败
- 确保所有文件都是有效的SHP格式
- 检查文件的几何类型是否兼容
- 确认坐标系统可以正确转换
- 查看预览信息中的兼容性警告

### 6. 合并后要素数量异常
- 检查是否选择了正确的合并策略
- 联合合并会自动去除重复要素
- 确认原始文件中没有空要素或无效几何

## 技术支持

如遇到问题，请检查：

1. **Python环境** - 确保Python版本兼容
2. **依赖包** - 检查所有依赖是否正确安装
3. **数据库连接** - 验证连接参数和网络
4. **数据格式** - 确认坐标字段格式正确

## 更新日志

### v1.2.0 (2024-10-09)
- 新增空间统计分析工具
- 支持面图层与目标图层的空间关系统计
- 实现点、线、面多种几何类型的分析
- 采用最大归属原则避免重复统计
- 提供详细的统计结果和多格式导出
- 添加空间索引优化提高分析性能
- 完善数据验证和错误处理机制

### v1.1.0 (2024-10-09)
- 新增SHP文件合并工具
- 支持多个SHP文件的智能合并
- 添加几何类型兼容性检查
- 实现坐标系统自动转换
- 提供详细的合并预览功能
- 优化界面用户体验

### v1.0.0 (2024-09-30)
- 初始版本发布
- 支持MySQL数据库连接
- 实现坐标解析和SHP导出
- 提供图形化用户界面

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 贡献

欢迎提交问题报告和功能建议到项目仓库。